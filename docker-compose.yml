services:
  # Frontend
  frontend:
    build: .
    ports:
      - "9007:8080"
    depends_on:
      - backend

  # Backend
  backend:
    build: ./backend
    ports:
      - "5004:3000"
    env_file:
      - ./backend/.env.production
    volumes:
      # Mount data directory for settings
      - ./backend/data:/app/data
      # Mount temp directory for uploads
      - ./backend/temp:/app/temp
      # Mount network share for document access
      - network-share:/mnt/network-share
    # Run as root to allow CIFS mounting
    user: root
    # Add capabilities for mounting
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    # Enable privileged mode for CIFS mounting
    privileged: true
    # Security options for CIFS mounting
    security_opt:
      - apparmor:unconfined
    # Additional environment variables for network share
    environment:
      - SHARE_HOST=mbma.com
      - SHARE_PATH=shared/PR_Document/PT Merdeka Tsingshan Indonesia
    # depends_on removed - SQL Server runs on separate server

# Note: SQL Server is running on a separate server
# Database connection configured via environment variables
# Network share access is configured via CIFS volume mount

volumes:
  network-share:
    driver: local
    driver_opts:
      type: cifs
      o: "username=mbma\\ict.supportassistant,password=P@ssw0rd.123,uid=1000,gid=1000,iocharset=utf8,file_mode=0777,dir_mode=0777,vers=3.0"
      device: "//10.60.10.44/pr_document"